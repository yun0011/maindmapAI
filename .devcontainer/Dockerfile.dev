# uv 패키지 매니저를 먼저 가져옴
FROM ghcr.io/astral-sh/uv:latest AS uv

# Node.js 기반 이미지 사용 (최종 이미지)
FROM node:20.19.0

# Python 설치
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    locales \
    tzdata \
    less \
    wget \
    curl \
    vim \
    neovim \
    git \
    jq \
    tree \
    htop \
    procps \
    lsof \
    dnsutils \
    netcat-openbsd \
    tcpdump \
    net-tools \
    telnet \
    unzip \
    zsh \
    gosu \
    && rm -rf /var/lib/apt/lists/*

# python3를 python으로 심볼릭 링크 생성
RUN ln -s /usr/bin/python3 /usr/bin/python

# externally-managed-environment 제약 제거 (개발 환경이므로 안전함)
RUN rm -f /usr/lib/python*/EXTERNALLY-MANAGED

# 로케일/타임존
RUN localedef -i en_US -c -f UTF-8 -A /usr/share/locale/locale.alias en_US.UTF-8 \
 && localedef -i ko_KR -c -f UTF-8 -A /usr/share/locale/locale.alias ko_KR.UTF-8 \
 && ln -sf /usr/share/zoneinfo/Asia/Seoul /etc/localtime

# 환경 변수
ENV TZ=Asia/Seoul \
    LC_ALL=en_US.utf8 \
    LANG=en_US.utf8 \
    LC_CTYPE=ko_KR.UTF-8 \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=off \
    PIP_DISABLE_PIP_VERSION_CHECK=on \
    PIP_DEFAULT_TIMEOUT=100 \
    PIP_BREAK_SYSTEM_PACKAGES=1

# 작업 디렉토리 설정
WORKDIR /workspace

# oh-my-zsh & 플러그인
ENV ZSH_CUSTOM="/root/.oh-my-zsh/custom"
RUN sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended \
 && git clone https://github.com/zsh-users/zsh-autosuggestions "${ZSH_CUSTOM}/plugins/zsh-autosuggestions" \
 && git clone https://github.com/zsh-users/zsh-syntax-highlighting.git "${ZSH_CUSTOM}/plugins/zsh-syntax-highlighting" \
 && git clone --depth=1 https://github.com/romkatv/powerlevel10k.git "${ZSH_CUSTOM}/themes/powerlevel10k" \
 && sed -i 's/ZSH_THEME=.*/ZSH_THEME="powerlevel10k\/powerlevel10k"/' ~/.zshrc \
 && sed -i 's/plugins=.*/plugins=(git zsh-autosuggestions zsh-syntax-highlighting)/' ~/.zshrc \
 && echo 'POWERLEVEL9K_DISABLE_CONFIGURATION_WIZARD=true' >> ~/.zshrc

# uv 바이너리를 첫 번째 스테이지에서 복사
COPY --from=uv /uv /uvx /bin/

# 기본 셸을 zsh로 변경
ENV SHELL=/bin/zsh

# NOTE: devcontainer.json의 postCreateCommand가 실행되도록 CMD는 설정하지 않음
